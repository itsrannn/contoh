<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Detail Produk | Carita Hidroponik</title>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/product detail.css" />
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 768px)" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css"
    />
  </head>

  <body x-data @alpine:init="
    $store.products.init();
    $store.cart.init();
  ">
    <!-- ========== HEADER INCLUDE ========== -->
    <div id="header-include"></div>

    <!-- ================== Product Detail Section ================== -->
    <main class="container" x-data="productDetail()" x-cloak>
      <p x-show="$store.products.isLoading" class="loading-text">Memuat produk...</p>

      <div x-show="!$store.products.isLoading && !product">
        <h1 class="product-detail-title">Produk Tidak Ditemukan</h1>
        <p>
          Maaf, produk yang Anda cari tidak dapat ditemukan. Silakan kembali ke
          halaman utama.
        </p>
      </div>

      <div x-show="!$store.products.isLoading && product">
        <section class="product-detail-banner">
          <nav class="breadcrumb">
            <a href="index.html">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="index.html#Product">Produk</a>
            <span class="breadcrumb-separator">/</span>
            <span x-text="product.name"></span>
          </nav>
        </section>

        <!-- SECTION HEAD -->
        <section class="product-detail-head">
          <div class="product-detail-img">
            <img
              :src="product.image_url ? product.image_url : 'img/general/default.jpg'"
              :alt="product.name"
            />
          </div>
          <div class="product-detail-info">
            <h2 x-text="product.category.toUpperCase()" class="badge-category"></h2>
            <h1 x-text="product.name" class="product-detail-title"></h1>
            <p x-text="formatRupiah(product.price)" class="product-detail-price"></p>
            <p x-html="product.char" class="product-detail-desc-short"></p>
            <button
              @click="$store.cart.add(product.id)"
              class="btn-sm add-cart"
            >
              <i data-feather="shopping-bag"></i> Tambah ke Keranjang
            </button>
          </div>
        </section>

        <!-- SECTION DESKRIPSI -->
        <section class="product-detail-description">
          <h2>Deskripsi Produk</h2>
          <p x-text="product.description"></p>
        </section>

        <!-- SECTION PRODUK TERKAIT -->
        <section class="related-products">
          <h2>Produk Terkait</h2>

          <div x-show="relatedProducts.length > 0" class="swiper related-product-slider">
            <div class="swiper-wrapper">
              <template x-for="item in relatedProducts" :key="item.id">
                <div class="swiper-slide">
                  <a :href="'product detail.html?id=' + item.id" class="product-link">
                    <article class="product-card">
                      <figure class="product-media">
                        <img
                          :src="item.image_url ? item.image_url : 'img/general/default.jpg'"
                          :alt="item.name"
                        />
                      </figure>
                      <div class="product-body">
                        <h3 class="product-title" x-text="item.name"></h3>
                        <div class="product-meta">
                          <div
                            class="price"
                            x-text="formatRupiah(item.price)"
                          ></div>
                          <button
                            class="btn-sm add-cart"
                            @click.prevent.stop="$store.cart.add(item.id)"
                          >
                            <i data-feather="shopping-bag"></i>
                            Add
                          </button>
                        </div>
                      </div>
                    </article>
                  </a>
                </div>
              </template>
            </div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-pagination"></div>
          </div>

          <p x-show="relatedProducts.length === 0" class="muted" style="text-align: center;">
            Tidak ada produk terkait lainnya.
          </p>
        </section>
      </div>
    </main>

    <!-- ========== FOOTER INCLUDE ========== -->
    <div id="footer-include"></div>

    <!-- ================== Script ================== -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>

    <!-- Alpine Core -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js?nounit=true" defer></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js" defer></script>

    <!-- App Logic -->
    <script src="js/main.js" defer></script>

    <!-- General Scripts -->
    <script src="js/include.js" defer></script>
    <script src="js/script.js" defer></script>

    <script>
      function productDetail() {
        return {
          product: null,
          relatedProducts: [],
          init() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            this.$watch('$store.products.isLoading', (isLoading) => {
              if (!isLoading) {
                this.product = this.$store.products.getProductById(productId);
                if (this.product) {
                  document.title = "Carita Hidroponik | " + this.product.name;
                  this.fetchRelatedProducts();
                }
              }
            });
          },
          fetchRelatedProducts() {
            if (!this.product) return;
            this.relatedProducts = this.$store.products.all.filter(p =>
              p.category === this.product.category && String(p.id) !== String(this.product.id)
            );
            this.$nextTick(() => this.initSwiper());
          },
          formatRupiah(value) {
            if (!value) return "Rp 0";
            return "Rp " + value.toLocaleString("id-ID");
          },
          initSwiper() {
            if (this.relatedProducts.length === 0) return;
            new Swiper(".related-product-slider", {
              loop: true,
              spaceBetween: 15,
              navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
              },
              pagination: {
                el: ".swiper-pagination",
                clickable: true,
              },
              breakpoints: {
                320: { slidesPerView: 2, spaceBetween: 10 },
                768: { slidesPerView: 5, spaceBetween: 20 },
              },
            });
            this.$nextTick(() => feather.replace());
          },
        }
      }
    </script>
  </body>
</html>
