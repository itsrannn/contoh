<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - Carita Hidroponik</title>

    <!-- ========== STYLE ========== -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/admin.css" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- ========== HEADER INCLUDE ========== -->
    <div id="header-include"></div>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <section class="admin-section">
        <div class="container">
          <h2 class="section-title">Manajemen Pesanan Masuk</h2>
          <div class="order-table-container">
            <table class="order-table">
              <thead>
                <tr>
                  <th>ID Pesanan</th>
                  <th>Tanggal</th>
                  <th>Detail Pesanan</th>
                  <th>Total Harga</th>
                  <th>Tindakan</th>
                </tr>
              </thead>
              <tbody id="order-list">
                <!-- Data pesanan akan dimuat di sini -->
              </tbody>
            </table>
            <div id="no-orders-message" class="no-orders-message" style="display: none;">
              Tidak ada pesanan yang menunggu persetujuan.
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- ========== FOOTER INCLUDE ========== -->
    <div id="footer-include"></div>

    <!-- ========== SCRIPTS ========== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="js/app.js"></script>
    <script src="js/include.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"
      defer
    ></script>
    <script src="js/script.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const orderListBody = document.getElementById('order-list');
        const noOrdersMessage = document.getElementById('no-orders-message');

        // --- Cek Role Admin ---
        const {
          data: { user },
          error: userError,
        } = await supabase.auth.getUser();

        if (userError || !user) {
          alert('Anda harus login untuk mengakses halaman ini.');
          window.location.href = 'login page.html';
          return;
        }

        const { data: profile, error: profileError } = await supabase
          .from('users')
          .select('role')
          .eq('id', user.id)
          .single();

        if (profileError || !profile || profile.role !== 'admin') {
          alert('Hanya admin yang dapat mengakses halaman ini.');
          window.location.href = 'login page.html';
          return;
        }
        // --- Akhir Cek Role Admin ---

        async function fetchOrders() {
          const { data: orders, error } = await supabase
            .from('pesanan')
            .select('*')
            .eq('status', 'pending')
            .order('tanggal_pesanan', { ascending: false });

          if (error) {
            console.error('Error fetching orders:', error);
            orderListBody.innerHTML = `<tr><td colspan="5" class="error-message">Gagal memuat pesanan. Silakan coba lagi.</td></tr>`;
            return;
          }

          if (orders.length === 0) {
            orderListBody.innerHTML = '';
            noOrdersMessage.style.display = 'block';
            return;
          }

          noOrdersMessage.style.display = 'none';
          orderListBody.innerHTML = orders
            .map(
              (order) => `
                <tr id="order-${order.id_pesanan}">
                  <td data-label="ID Pesanan">#${order.id_pesanan}</td>
                  <td data-label="Tanggal">${new Date(
                    order.tanggal_pesanan
                  ).toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                  })}</td>
                  <td data-label="Detail Pesanan" class="order-details">
                    <ul>
                      ${order.detail_produk
                        .map(
                          (item) => `
                        <li>${item.name} <span>(${
                            item.quantity
                          }x)</span></li>
                      `
                        )
                        .join('')}
                    </ul>
                  </td>
                  <td data-label="Total Harga">Rp ${order.total_harga.toLocaleString(
                    'id-ID'
                  )}</td>
                  <td data-label="Tindakan" class="order-actions">
                    <button class="btn btn-accept" data-id="${
                      order.id_pesanan
                    }">Terima</button>
                    <button class="btn btn-reject" data-id="${
                      order.id_pesanan
                    }">Tolak</button>
                  </td>
                </tr>
              `
            )
            .join('');
        }

        async function updateOrderStatus(orderId, newStatus) {
          const { error } = await supabase
            .from('pesanan')
            .update({ status: newStatus })
            .eq('id_pesanan', orderId);

          if (error) {
            alert(`Gagal mengupdate status pesanan: ${error.message}`);
          } else {
            alert(`Pesanan berhasil di${newStatus === 'accepted' ? 'terima' : 'tolak'}.`);
            await fetchOrders(); // Refresh list
          }
        }

        orderListBody.addEventListener('click', (event) => {
          const target = event.target;
          const orderId = target.dataset.id;

          if (!orderId) return;

          if (target.classList.contains('btn-accept')) {
            if (confirm('Apakah Anda yakin ingin menerima pesanan ini?')) {
              updateOrderStatus(orderId, 'accepted');
            }
          } else if (target.classList.contains('btn-reject')) {
            if (confirm('Apakah Anda yakin ingin menolak pesanan ini?')) {
              updateOrderStatus(orderId, 'rejected');
            }
          }
        });

        await fetchOrders();
      });
    </script>
  </body>
</html>
