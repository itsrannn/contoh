<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login Page | Carita Hidroponik</title>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/login page.css" />
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 768px)" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script src="js/supabase-client.js"></script>
  </head>

  <body>
    <div id="header-include"></div>

    <section class="login">
      <div class="container">
        <section>
          <div class="login-form active" id="login-form">
            <form>
              <input type="hidden" name="login" value="1" />
              <h1>Login</h1>
              <div class="input-box">
                <input type="email" name="email" placeholder="Email" required />
                <i data-feather="mail"></i>
              </div>

              <div class="input-box">
                <input
                  type="password"
                  name="password"
                  placeholder="Password"
                  required
                />
                <i data-feather="lock"></i>
              </div>
              <div class="remember-forgot">
                <label><input type="checkbox" />Remember me</label>
                <a href="#">Forgot Password?</a>
              </div>
              <button type="submit" class="btn">Login</button>
              <div class="register-link">
                <p>
                  Don't have an account?
                  <a href="#" onclick="showForm('register-form')">Register</a>
                </p>
              </div>
            </form>
          </div>
          <div id="verification-message" style="text-align: center; color: var(--text-color); display: none;">
            <h2>Pendaftaran Berhasil!</h2>
            <p>Kami telah mengirimkan tautan verifikasi ke email Anda. Silakan periksa kotak masuk Anda untuk menyelesaikan pendaftaran.</p>
          </div>
        </section>
        <section>
          <div class="login-form" id="register-form">
            <form>
              <input type="hidden" name="register" value="1" />
              <h1>Register</h1>

              <div class="input-box">
                <input type="text" name="name" placeholder="Name" required />
                <i data-feather="user"></i>
              </div>

              <div class="input-box">
                <input type="email" name="email" placeholder="Email" required />
                <i data-feather="mail"></i>
              </div>

              <div class="input-box">
                <input
                  type="password"
                  name="password"
                  placeholder="Password"
                  required
                />
                <i data-feather="lock"></i>
              </div>

              <div class="remember-forgot">
                <label><input type="checkbox" /> Remember me</label>
              </div>

              <button type="submit" class="btn">Register</button>

              <div class="register-link">
                <p>
                  Already have an account?
                  <a href="#" onclick="showForm('login-form')">Login</a>
                </p>
              </div>
            </form>
          </div>
        </section>
      </div>
    </section>

    <div id="footer-include"></div>

    <script src="https://unpkg.com/feather-icons"></script>

    <script src="js/include.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"
      defer
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>
    <script src="js/script.js"></script>

    <script>
      function showForm(formIdToShow) {
        document.querySelectorAll(".login-form").forEach((form) => {
          form.classList.remove("active");
        });

        const targetForm = document.getElementById(formIdToShow);
        if (targetForm) {
          targetForm.classList.add("active");
        }
      }
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.querySelector('#login-form form');
        const registerForm = document.querySelector('#register-form form');

        // --- Role-based redirection logic ---
        const handleRedirect = async (user) => {
          // Attempt to fetch the user's role.
          const { data: profile } = await supabase
            .from('profiles')
            .select('role')
            .eq('id', user.id)
            .single();

          // Secure default: if profile doesn't load or role is not admin,
          // redirect to the customer account page.
          if (profile && profile.role && profile.role.toLowerCase() === 'admin') {
            window.location.href = 'admin.html';
          } else {
            window.location.href = 'my account.html';
          }
        };

        // --- Login Form Handler ---
        loginForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const email = loginForm.email.value;
          const password = loginForm.password.value;

          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            alert(`Error: ${error.message}`);
          } else if (data.user) {
            await handleRedirect(data.user);
          }
        });

        // --- Registration Form Handler ---
        registerForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const name = registerForm.name.value;
          const email = registerForm.email.value;
          const password = registerForm.password.value;

          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              data: { full_name: name }
            }
          });

          if (error) {
            alert(`Error: ${error.message}`);
          } else {
            // Hide the registration form
            registerForm.style.display = 'none';
            // Show the verification message
            const verificationMessage = document.getElementById('verification-message');
            verificationMessage.style.display = 'block';
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>
  </body>
</html>
