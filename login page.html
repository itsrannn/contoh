<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login Page | Carita Hidroponik</title>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/login page.css" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="js/supabase-client.js"></script>
  </head>

  <body>
    <div id="header-include"></div>

    <section class="login">
      <div class="container">
        <!-- LOGIN -->
        <section>
          <div class="login-form active" id="login-form">
            <form>
              <h1>Login</h1>
              <div class="input-box">
                <input type="email" name="email" placeholder="Email" required />
                <i data-feather="mail"></i>
              </div>

              <div class="input-box">
                <input
                  type="password"
                  name="password"
                  placeholder="Password"
                  required
                />
                <i data-feather="lock"></i>
              </div>

              <div class="remember-forgot">
                <label><input type="checkbox" /> Remember me</label>
                <a href="#">Forgot Password?</a>
              </div>

              <button type="submit" class="btn">Login</button>
              <div class="register-link">
                <p>
                  Don't have an account?
                  <a href="#" onclick="showForm('register-form')">Register</a>
                </p>
              </div>
            </form>
          </div>
        </section>

        <!-- REGISTER -->
        <section>
          <div class="login-form" id="register-form">
            <form>
              <h1>Register</h1>

              <div class="input-box">
                <input type="text" name="name" placeholder="Name" required />
                <i data-feather="user"></i>
              </div>

              <div class="input-box">
                <input type="email" name="email" placeholder="Email" required />
                <i data-feather="mail"></i>
              </div>

              <div class="input-box">
                <input
                  type="password"
                  name="password"
                  placeholder="Password"
                  required
                />
                <i data-feather="lock"></i>
              </div>

              <button type="submit" class="btn">Register</button>

              <div class="register-link">
                <p>
                  Already have an account?
                  <a href="#" onclick="showForm('login-form')">Login</a>
                </p>
              </div>
            </form>
          </div>
        </section>
      </div>
    </section>

    <div id="footer-include"></div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="js/app.js"></script>
    <script src="js/include.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"
      defer
    ></script>
    <script src="js/script.js"></script>

    <script>
      function showForm(formIdToShow) {
        document.querySelectorAll(".login-form").forEach((form) => {
          form.classList.remove("active");
        });
        document.getElementById(formIdToShow).classList.add("active");
      }

      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loginForm = document.querySelector("#login-form form");
        const registerForm = document.querySelector("#register-form form");

        // Redirect after login based on role
        const handleRedirect = async (user) => {
          const { data: profile, error } = await supabase
            .from("users")
            .select("role")
            .eq("id", user.id)
            .single();

          if (error || !profile) {
            alert("Login berhasil, namun gagal memeriksa role Anda.");
            window.location.href = "my account.html";
            return;
          }

          if (profile.role === "admin") {
            window.location.href = "admin.html";
          } else {
            window.location.href = "my account.html";
          }
        };

        // Login
        loginForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const email = loginForm.email.value;
          const password = loginForm.password.value;

          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            alert(`Error: ${error.message}`);
          } else if (data.user) {
            await handleRedirect(data.user);
          }
        });

        // Register
        registerForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const name = registerForm.name.value;
          const email = registerForm.email.value;
          const password = registerForm.password.value;

          const { data, error } = await supabase.auth.signUp({
            email,
            password,
          });

          if (error) {
            alert(`Error: ${error.message}`);
          } else if (data.user) {
            // Insert ke tabel users
            const { error: insertError } = await supabase.from("users").insert([
              {
                id: data.user.id,
                nama: name,
                email: email,
                role: "customer",
              },
            ]);

            if (insertError) {
              alert(`Registrasi berhasil, tapi gagal membuat profil: ${insertError.message}`);
            }
            window.location.href = "my account.html";
          }
        });
      });
    </script>
  </body>
</html>
