<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Carita Hidroponik</title>

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/my account.css" />

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />

    <!-- Supabase Client -->
    <script type="module" src="js/supabase-client.js"></script>
  </head>

  <body>
    <!-- ========== HEADER INCLUDE ========== -->
    <div id="header-include"></div>

    <!--My Account start-->
    <section class="my-account">
      <div class="account-header">
        <i data-feather="user" class="feather-icons"></i>
        <h2>My Account</h2>
      </div>
      <div class="container">
        <form class="account-form" id="profile-form">
          <div class="form-group">
            <label for="profile-name">Name</label>
            <input type="text" id="profile-name" placeholder="Your name" />
          </div>
          <div class="form-group">
            <label for="profile-email">Email</label>
            <input type="email" id="profile-email" disabled />
          </div>
          <button type="submit" class="btn">Update Profile</button>
        </form>
      </div>

      <div class="account-header">
        <i data-feather="map-pin" class="feather-icons"></i>
        <h2>Shipping Address</h2>
      </div>
      <div class="container">
        <form class="account-form" id="address-form">
          <div class="form-group">
            <label for="address-street">Alamat</label>
            <input type="text" id="address-street" placeholder="Jl. Raya Cilebut No.123" />
          </div>
          <div class="form-group">
            <label for="address-province">Provinsi</label>
            <input type="text" id="address-province" placeholder="Jawa Timur" />
          </div>
          <div class="form-group">
            <label for="address-city">Kota/Kabupaten</label>
            <input type="text" id="address-city" placeholder="Kabupaten Malang" />
          </div>
          <div class="form-group">
            <label for="address-district">Kecamatan</label>
            <input type="text" id="address-district" placeholder="Turen" />
          </div>
          <div class="form-group">
            <label for="address-village">Desa/Kelurahan</label>
            <input type="text" id="address-village" placeholder="Sedayu" />
          </div>
          <div class="form-group">
            <label for="address-postal-code">Postal Code</label>
            <input type="text" id="address-postal-code" placeholder="65175" />
          </div>
          <button type="submit" class="btn">Update Address</button>
        </form>
      </div>

      <div class="account-header">
        <i data-feather="archive" class="feather-icons"></i>
        <h2>Order History</h2>
      </div>

      <div class="container">
        <table class="order-history">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Status</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>#12345</td>
              <td>2023-10-01</td>
              <td>Completed</td>
              <td>Rp 150.000</td>
              <td class="td-center">
                <button class="btn">View Details</button>
              </td>
            </tr>
            <tr>
              <td>#12346</td>
              <td>2023-10-05</td>
              <td>Processing</td>
              <td>Rp 200.000</td>
              <td class="td-center">
                <button class="btn">View Details</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="no-orders" style="display: none">
          <p>You have no past orders.</p>
        </div>
      </div>

      <!-- Logout button -->
      <div class="logout-container">
        <button class="btn logout-btn">Logout</button>
      </div>
    </section>
    <!--My Account end-->

    <!-- ========== FOOTER INCLUDE ========== -->
    <div id="footer-include"></div>
    
    <!-- ================== SCRIPTS ================== -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="js/app.js"></script>
    <script src="js/include.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"
      defer
    ></script>
    <script src="js/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>

    <script type="module">
      import { supabase } from './js/supabase-client.js';

      document.addEventListener('DOMContentLoaded', async () => {
        const profileForm = document.getElementById('profile-form');
        const addressForm = document.getElementById('address-form');
        const logoutButton = document.querySelector('.logout-btn');

        // Check for active session
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = 'login page.html';
          return;
        }

        const user = session.user;

        // Fetch profile data
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        // If there's an error fetching, it might be because the profile doesn't exist yet.
        // We log the error but continue, allowing the user to create their profile.
        if (error && error.code !== 'PGRST116') { // PGRST116 = 0 rows
          console.error('Error fetching profile:', error);
          return; // For critical errors, we stop.
        }

        // Populate forms, checking if profile exists
        document.getElementById('profile-name').value = profile?.full_name || '';
        document.getElementById('profile-email').value = user.email;
        document.getElementById('address-street').value = profile?.address || '';
        document.getElementById('address-province').value = profile?.province || '';
        document.getElementById('address-city').value = profile?.city || '';
        document.getElementById('address-district').value = profile?.district || '';
        document.getElementById('address-village').value = profile?.village || '';
        document.getElementById('address-postal-code').value = profile?.postal_code || '';

        // Handle profile update (using upsert)
        profileForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const profileData = {
            id: user.id, // Include the ID for the upsert
            full_name: document.getElementById('profile-name').value,
          };

          const { error } = await supabase
            .from('profiles')
            .upsert(profileData, { onConflict: 'id' });

          if (error) {
            alert(`Error updating profile: ${error.message}`);
          } else {
            alert('Profile updated successfully!');
          }
        });

        // Handle address update (using upsert)
        addressForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const address = {
            id: user.id, // Include the ID for the upsert
            address: document.getElementById('address-street').value,
            province: document.getElementById('address-province').value,
            city: document.getElementById('address-city').value,
            district: document.getElementById('address-district').value,
            village: document.getElementById('address-village').value,
            postal_code: document.getElementById('address-postal-code').value,
          };

          const { error } = await supabase
            .from('profiles')
            .upsert(address, { onConflict: 'id' });

          if (error) {
            alert(`Error updating address: ${error.message}`);
          } else {
            alert('Address updated successfully!');
          }
        });

        // Handle logout
        logoutButton.addEventListener('click', async () => {
          const { error } = await supabase.auth.signOut();
          if (error) {
            console.error('Error signing out:', error);
          } else {
            window.location.href = 'login page.html';
          }
        });
      });
    </script>
    <!-- Feather Icons -->
    <script>
      feather.replace();
    </script>
  </body>
</html>
