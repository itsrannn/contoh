<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Keranjang Saya - Carita Hidroponik</title>

    <!-- ========== STYLE ========== -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/my cart.css" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>

  <body x-data @alpine:init="$store.cart.init()">
    <!-- ========== HEADER INCLUDE ========== -->
    <div id="header-include"></div>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <section class="cart-section">
        <div class="container">
          <h2 class="section-title">Keranjang Belanja</h2>
          <div class="cart-layout">
            <!-- CART ITEMS -->
            <div class="cart-items-container">
              <div class="cart-header">
                <div class="header-product">Produk</div>
                <div class="header-quantity">Kuantitas</div>
                <div class="header-total">Total</div>
              </div>

              <div id="cart-items-list" x-data="{ cart: $store.cart }">
                <template x-if="cart.items.length === 0">
                  <p class="cart-empty-message">Keranjang belanja Anda kosong.</p>
                </template>

                <template x-for="item in cart.items" :key="item.id">
                  <div class="cart-item">
                    <div class="cart-item-product">
                      <img :src="item.img" :alt="item.name" class="cart-item-image" />
                      <div class="cart-item-details">
                        <h4 class="item-name" x-text="item.name"></h4>
                        <div class="item-price" x-text="`Rp ${item.price.toLocaleString('id-ID')}`"></div>
                      </div>
                    </div>
                    <div class="cart-item-quantity">
                      <button class="quantity-btn" @click="cart.remove(item.id)" aria-label="Kurangi">-</button>
                      <span class="quantity-value" x-text="item.quantity"></span>
                      <button class="quantity-btn" @click="cart.add(item)" aria-label="Tambah">+</button>
                    </div>
                    <div class="cart-item-total" x-text="`Rp ${(item.quantity * item.price).toLocaleString('id-ID')}`"></div>
                    <button class="cart-item-remove" @click="cart.remove(item.id, true)" aria-label="Hapus item">
                      <i data-feather="trash-2"></i>
                    </button>
                  </div>
                </template>
              </div>

              <a href="index.html#Product" class="continue-shopping">
                <i data-feather="arrow-left"></i> Lanjut Belanja
              </a>
            </div>

            <!-- SUMMARY -->
            <div class="cart-summary" x-data="{ cart: $store.cart }">
              <h3>Ringkasan Belanja</h3>

              <div class="coupon-form">
                <input type="text" placeholder="Masukkan Kode Kupon" />
                <button class="btn btn-secondary">Terapkan</button>
              </div>

              <div class="summary-item">
                <span>Subtotal</span>
                <span id="summary-subtotal" x-text="`Rp ${cart.total.toLocaleString('id-ID')}`">Rp 0</span>
              </div>
              <div class="summary-item">
                <span>Ongkos Kirim</span>
                <span id="summary-shipping">Rp 0</span>
              </div>

              <div class="summary-total">
                <span>Total</span>
                <span id="summary-total" x-text="`Rp ${cart.total.toLocaleString('id-ID')}`">Rp 0</span>
              </div>

              <button id="checkout-btn" class="btn btn-primary btn-block" :disabled="cart.items.length === 0">
                Checkout Sekarang
              </button>
            </div>
          </div>
        </div>
      </section>

      <div id="notification" class="notification"></div>
    </main>

    <!-- ========== FOOTER INCLUDE ========== -->
    <div id="footer-include"></div>

    <!-- ========== SCRIPTS ========== -->
    <!-- Load Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <!-- Load our custom Supabase client -->
    <script src="js/supabase-client.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="js/app.js"></script>
    <script src="js/include.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"
      defer
    ></script>
    <script src="js/script.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const checkoutBtn = document.getElementById('checkout-btn');

        checkoutBtn.addEventListener('click', async () => {
          const {
            data: { user },
          } = await supabase.auth.getUser();

          if (!user) {
            alert('Anda harus login untuk melakukan checkout.');
            window.location.href = 'login page.html';
            return;
          }

          const cartStore = Alpine.store('cart');
          if (cartStore.items.length === 0) {
            alert('Keranjang Anda kosong.');
            return;
          }

          const orderDetails = cartStore.items.map((item) => ({
            product_id: item.id,
            name: item.name,
            quantity: item.quantity,
            price: item.price,
          }));

          const totalHarga = cartStore.total;

          const { data, error } = await supabase
            .from('pesanan')
            .insert([
              {
                user_id: user.id,
                detail_produk: orderDetails,
                total_harga: totalHarga,
                status: 'pending',
              },
            ])
            .select();

          if (error) {
            console.error('Error saat membuat pesanan:', error);
            alert(`Terjadi kesalahan: ${error.message}`);
          } else {
            alert('Pesanan Anda berhasil dibuat dan sedang menunggu konfirmasi!');

            // Kosongkan keranjang
            cartStore.items = [];
            cartStore.updateTotalsAndSave(); // Ini akan mengosongkan localStorage juga

            // Arahkan ke halaman "My Account" atau halaman konfirmasi
            window.location.href = 'my account.html';
          }
        });
      });
    </script>
  </body>
</html>
